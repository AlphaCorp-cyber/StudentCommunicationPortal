{% extends "base.html" %}

{% block title %}WhatsApp Bot Test - DriveLink{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card bg-dark text-light">
                <div class="card-header">
                    <h4><i data-feather="message-circle"></i> WhatsApp Bot Test Interface</h4>
                    <small class="text-muted">Test the enhanced multi-role WhatsApp bot system</small>
                </div>
                <div class="card-body">
                    <!-- Bot Status -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-secondary">
                                <div class="card-body">
                                    <h6>Bot Status</h6>
                                    <div id="bot-status">
                                        <span class="text-warning">Checking...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-secondary">
                                <div class="card-body">
                                    <h6>Supported User Types</h6>
                                    <ul class="mb-0">
                                        <li>üéì Students (with registration)</li>
                                        <li>üë®‚Äçüè´ Instructors</li>
                                        <li>üë®‚Äçüíº Admins</li>
                                        <li>üîß Super Admins</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Message Interface -->
                    <div class="card bg-secondary mb-4">
                        <div class="card-header">
                            <h6>Test Message Sending</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="phone-number">Phone Number</label>
                                        <input type="text" class="form-control" id="phone-number" 
                                               placeholder="+263719092710" value="+263719092710">
                                        <small class="form-text text-muted">Include country code</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="test-message">Test Message</label>
                                        <select class="form-control" id="test-message">
                                            <option value="hi">hi (Greeting)</option>
                                            <option value="menu">menu (Main Menu)</option>
                                            <option value="start">start (Registration)</option>
                                            <option value="students">students (Instructor Menu)</option>
                                            <option value="help">help (Help)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label for="custom-message">Or Custom Message</label>
                                <input type="text" class="form-control" id="custom-message" 
                                       placeholder="Type custom message here">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="sendTestMessage()">
                                <i data-feather="send"></i> Send Test Message
                            </button>
                        </div>
                    </div>

                    <!-- Bot Features -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-success mb-3">
                                <div class="card-body">
                                    <h6><i data-feather="user-plus"></i> Student Features</h6>
                                    <ul class="small mb-0">
                                        <li>New registration with documents</li>
                                        <li>Lesson booking and tracking</li>
                                        <li>Progress monitoring</li>
                                        <li>Instructor browsing</li>
                                        <li>Profile management</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info mb-3">
                                <div class="card-body">
                                    <h6><i data-feather="users"></i> Instructor Features</h6>
                                    <ul class="small mb-0">
                                        <li>Student management</li>
                                        <li>Today's lessons</li>
                                        <li>Schedule overview</li>
                                        <li>Earnings tracking</li>
                                        <li>Profile updates</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning mb-3">
                                <div class="card-body">
                                    <h6><i data-feather="settings"></i> Admin Features</h6>
                                    <ul class="small mb-0">
                                        <li>User management</li>
                                        <li>System oversight</li>
                                        <li>Approval workflows</li>
                                        <li>Reports and analytics</li>
                                        <li>Configuration</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Log -->
                    <div class="card bg-secondary">
                        <div class="card-header">
                            <h6>Message Log</h6>
                            <button type="button" class="btn btn-sm btn-outline-light float-right" onclick="clearLog()">
                                Clear Log
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="message-log" style="height: 300px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 5px;">
                                <div class="text-muted">Message responses will appear here...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Setup Instructions -->
                    <div class="card bg-dark mt-4">
                        <div class="card-header">
                            <h6><i data-feather="info"></i> WhatsApp Setup Instructions</h6>
                        </div>
                        <div class="card-body">
                            <h6>Webhook Configuration</h6>
                            <p>Set your Twilio webhook URL to:</p>
                            <code id="webhook-url">{{ request.url_root }}whatsapp/webhook</code>
                            <button type="button" class="btn btn-sm btn-outline-light ml-2" onclick="copyWebhookUrl()">
                                Copy
                            </button>
                            
                            <h6 class="mt-3">Testing Steps</h6>
                            <ol>
                                <li>Configure your Twilio WhatsApp sandbox or approved number</li>
                                <li>Set the webhook URL in your Twilio console</li>
                                <li>Add phone numbers to your sandbox (for testing)</li>
                                <li>Send messages to your WhatsApp bot number</li>
                                <li>Use this interface to test specific scenarios</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check bot status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkBotStatus();
    feather.replace();
});

function checkBotStatus() {
    fetch('/whatsapp/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('bot-status');
            if (data.status === 'active') {
                statusDiv.innerHTML = `
                    <span class="text-success">‚úÖ Active</span><br>
                    <small>Twilio: ${data.twilio_configured ? 'Connected' : 'Not configured'}</small><br>
                    <small>Phone: ${data.phone_number || 'Not set'}</small><br>
                    <small>Version: ${data.bot_version}</small>
                `;
            } else {
                statusDiv.innerHTML = '<span class="text-danger">‚ùå Inactive</span>';
            }
        })
        .catch(error => {
            document.getElementById('bot-status').innerHTML = '<span class="text-danger">‚ùå Error checking status</span>';
        });
}

function sendTestMessage() {
    const phoneNumber = document.getElementById('phone-number').value;
    const testMessage = document.getElementById('test-message').value;
    const customMessage = document.getElementById('custom-message').value;
    
    const message = customMessage || testMessage;
    
    if (!phoneNumber || !message) {
        alert('Please enter both phone number and message');
        return;
    }
    
    // Show sending status
    addToLog('SENDING', `To: ${phoneNumber}`, message, 'text-warning');
    
    fetch('/whatsapp/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            phone_number: phoneNumber,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'sent') {
            addToLog('SENT', `To: ${phoneNumber}`, message, 'text-success');
        } else {
            addToLog('ERROR', `To: ${phoneNumber}`, data.message || 'Failed to send', 'text-danger');
        }
    })
    .catch(error => {
        addToLog('ERROR', `To: ${phoneNumber}`, error.message, 'text-danger');
    });
}

function addToLog(status, recipient, message, className) {
    const log = document.getElementById('message-log');
    const timestamp = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = `mb-2 ${className}`;
    logEntry.innerHTML = `
        <strong>[${timestamp}] ${status}</strong><br>
        <small>${recipient}</small><br>
        <span>${message}</span>
    `;
    
    log.appendChild(logEntry);
    log.scrollTop = log.scrollHeight;
}

function clearLog() {
    document.getElementById('message-log').innerHTML = '<div class="text-muted">Message log cleared...</div>';
}

function copyWebhookUrl() {
    const url = document.getElementById('webhook-url').textContent;
    navigator.clipboard.writeText(url).then(() => {
        alert('Webhook URL copied to clipboard!');
    });
}
</script>
{% endblock %}